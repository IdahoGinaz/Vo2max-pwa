<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VO2 from FIT</title>
<link rel="manifest" href="manifest.json" />
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111}
  body{max-width:900px;margin:20px auto;padding:16px}
  h1{font-size:1.25rem;margin:0 0 12px}
  p{margin:6px 0 12px;color:#333}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=file]{padding:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:0.95rem}
  th{background:#f4f4f4}
  .btn{padding:8px 10px;background:#0078d4;color:white;border-radius:6px;border:none;cursor:pointer}
  .muted{color:#666;font-size:0.9rem}
  footer{margin-top:18px;color:#666;font-size:0.85rem}
  .error{color:#b00020}
</style>
</head>
<body>
  <h1>VO2 extractor for Garmin FIT</h1>
  <p class="muted">Drop or choose .fit or .zip (export original from Garmin Connect). Client side only. Install to home screen for quick access.</p>

  <div class="controls">
    <input id="files" type="file" multiple />
    <button id="exportCsv" class="btn">Export CSV</button>
    <div id="status" class="muted">Ready</div>
  </div>

  <table id="out">
    <thead><tr><th>File</th><th>Activity Time</th><th>VO2 mL/kg/min</th><th>Notes</th></tr></thead>
    <tbody></tbody>
  </table>

  <footer>
    Tip: if no VO2 appears the activity may not include the VO2 message. Use "Export Original" from Garmin Connect for the best chance.
  </footer>

<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/fit-file-parser@1.5.0/dist/fit-parser.min.js"></script>
<script>
const input = document.getElementById('files');
const tbody = document.querySelector('#out tbody');
const status = document.getElementById('status');
const exportBtn = document.getElementById('exportCsv');

input.addEventListener('change', handleFiles);
exportBtn.addEventListener('click', exportCsv);

async function handleFiles(e){
  tbody.innerHTML = '';
  status.textContent = 'Processing...';
  const files = Array.from(e.target.files);
  for(const f of files){
    try{
      const arr = new Uint8Array(await f.arrayBuffer());
      let fitBuf = arr;
      if (f.name.toLowerCase().endsWith('.zip')){
        const z = await JSZip.loadAsync(arr);
        const fitName = Object.keys(z.files).find(n => n.toLowerCase().endsWith('.fit'));
        if(!fitName) throw new Error('No .fit found in zip');
        fitBuf = new Uint8Array(await z.files[fitName].async('arraybuffer'));
      }

      await parseFitBuffer(f.name, fitBuf.buffer);
    }catch(err){
      appendRow(f.name, '-', '-', 'error: ' + err.message, true);
    }
  }
  status.textContent = 'Done';
}

function appendRow(file, time, vo, note, isError=false){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${esc(file)}</td><td>${esc(time)}</td><td>${esc(vo)}</td><td class="${isError? 'error':''}">${esc(note)}</td>`;
  tbody.appendChild(tr);
}

function esc(s){ return String(s===null||s===undefined? '': s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function exportCsv(){
  const rows = [['file','time','vo','notes']];
  for(const r of tbody.querySelectorAll('tr')){
    const cells = Array.from(r.children).map(td => td.textContent.replace(/\n/g,' ').trim());
    rows.push(cells);
  }
  const csv = rows.map(r => r.map(v => `"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'vo2-results.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* parse using fit-file-parser */
function parseFitBuffer(filename, buffer){
  return new Promise((resolve) => {
    const parser = new FitParser({force:true,mode:'list'});
    parser.parse(buffer, function(err, data){
      if(err){
        appendRow(filename,'-','-','parse error',true); return resolve();
      }
      let voVal = null;
      let time = '-';
      // data.messages is an array when mode:'list'
      if (Array.isArray(data.messages)){
        for(const msg of data.messages){
          // identify message 140 by id or name
          if (msg.id === 140 || (msg.name && msg.name.toLowerCase().includes('unknown_140'))){
            if (Array.isArray(msg.fields)){
              for(const fld of msg.fields){
                if (fld.fieldDefinitionNumber === 7 || fld.name === 'unknown_7'){
                  voVal = fld.value;
                }
              }
            }
          }
          // try to get a timestamp for the activity
          if (msg.name === 'file_id' && Array.isArray(msg.fields)){
            const tsf = msg.fields.find(f => f.name === 'timestamp' || f.fieldDefinitionNumber === 253);
            if (tsf && tsf.value) time = new Date(tsf.value).toISOString();
          }
          if ((msg.name && msg.name.toLowerCase().includes('session')) && Array.isArray(msg.fields)){
            const t = msg.fields.find(f => f.name === 'start_time' || f.name === 'timestamp' || f.fieldDefinitionNumber === 253);
            if (t && t.value) time = new Date(t.value).toISOString();
          }
        }
      } else if (data.activity){
        // fallback for other parser modes
        time = data.activity.start_time || time;
      }

      if (voVal == null){
        appendRow(filename, time, '-', 'no VO2 field found');
        return resolve();
      }
      const vo2 = (voVal * 3.5) / 65536;
      appendRow(filename, time, vo2.toFixed(3), 'extracted from message 140 field 7');
      resolve();
    });
  });
}

/* register service worker */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{/* ignore */});
}
</script>
</body>
</html>
